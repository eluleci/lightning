<!DOCTYPE html>
<html lang="en">
<head>
<title>Chat Example</title>
<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
        $(function () {

            var conn;
            var msg = document.getElementById("msg")
            var log = $("#log");

            function output(inp) {
                document.body.appendChild(document.createElement('pre')).innerHTML = inp;
            }

            function syntaxHighlight(json) {
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }

            // var obj = {a:1, 'b':'foo', c:[false,'false',null, 'null', {d:{e:1.3e5,f:'1.3e5'}}]};
            // var str = JSON.stringify(obj, undefined, 4);

            // output(str);
            // output(syntaxHighlight(str));


            function syntaxHighlight(json) {
                if (typeof json != 'string') {
                     json = JSON.stringify(json, undefined, 2);
                }
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }

            function appendLog(msg) {
                var d = log[0]
                var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
                // msg.appendTo(log)
                log.append($("<pre/>").text(msg))
                if (doScroll) {
                    d.scrollTop = d.scrollHeight - d.clientHeight;
                }
            }

            function sendMessage(message) {
                console.log(message)

                var rid = Math.floor(Math.random() * 100000000);
                message.rid = rid;
                msg = JSON.stringify(message)
                conn.send(msg);

                var messageContainer = document.createElement('div')
                messageContainer.id = rid
                document.body.appendChild(messageContainer)
                var messageDom = createMessageDom(message)
                if(messageDom) messageContainer.appendChild(messageDom)
            }

            function createMessageDom(message) {
                var msgDom = document.createElement('pre')
                msgDom.innerHTML = syntaxHighlight(JSON.stringify(message, undefined, 4));
                return msgDom
            }

            $("#createProfile").on('click', function () {
                if (!conn) {
                    return false;
                }
                var message = {
                    rid: 123123123,
                    cmd: 'post',
                    res: '/Profile',
                    body: {
                        name: 'Emrullah',
                        surname: 'LÃ¼leci',
                        avatar: 'https://graph.facebook.com/eluleci/picture?type=large'
                    }
                }
                sendMessage(message)
                return false
            });

            $("#updateProfile").on('click', function () {
                if (!conn) {
                    return false;
                }
                var message = {
                    rid: 123123123,
                    cmd: 'post',
                    res: '/Profile/' + document.getElementById("msg").value,
                    body: {
                        name: 'Haydar'
                    }
                }
                sendMessage(message)
                return false
            });

            $("#getProfile").on('click', function () {
                if (!conn) {
                    return false;
                }
                debugger;
                var message = {
                    rid: 123123123,
                    cmd: 'get',
                    res: '/Profile/' + document.getElementById("msg").value
                }
                sendMessage(message)
                return false
            });

            $("#getProfiles").on('click', function () {
                if (!conn) {
                    return false;
                }
                var message = {
                    rid: 123123123,
                    cmd: 'get',
                    res: '/Profile'
                }
                sendMessage(message)
                return false
            });


            $("#addAddress").on('click', function () {
                if (!conn) {
                    return false;
                }
                var message = {
                    rid: 123123123,
                    cmd: 'post',
                    res: '/Profile/'  + document.getElementById("msg").value + '/address/',
                    body: {
                        street: 'Yamac Sok',
                        no: '23'
                    }
                }
                sendMessage(message)
                return false
            });

            $("#getAddresses").on('click', function () {
                if (!conn) {
                    return false;
                }
                var message = {
                    rid: 123123123,
                    cmd: 'get',
                    res: '/Profile/'  + document.getElementById("msg").value + '/address'
                }
                sendMessage(message)
                return false
            });

            if (window["WebSocket"]) {
                conn = new WebSocket("ws://{{$}}/ws");
                conn.onclose = function (evt) {
                    appendLog($("<div><b>Connection closed.</b></div>"))
                }
                conn.onmessage = function (evt) {
                    var obj = JSON.parse(evt.data);
                    console.log(obj)
                    if(obj.rid){
                        // response message
                        var messageContainer = document.getElementById(obj.rid);
                        var messageDom = createMessageDom(obj)
                        if(messageDom) messageContainer.appendChild(messageDom)

                    } else {
                        // push message
                        var str = JSON.stringify(obj, undefined, 4);
                        output(syntaxHighlight(str));
                    }
                }
            } else {
                appendLog($("<div><b>Your browser does not support WebSockets.</b></div>"))
            }
        });
</script>
<style type="text/css">

    body {
        box-sizing: border-box;
    }

    pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
    .string { color: #888888; }
    .number { color: darkorange; }
    .boolean { color: blue; }
    .null { color: magenta; }
    .key { color: green; }

    #form {
    padding: 10px;
    position: fixed;
    bottom: 0;
    }

    div {
        overflow: auto;
    }

    div > pre {
        float: left;
        width: 48%;
        overflow-x: scroll;
    }
</style>
</head>
<body>

<div id="log"></div>
<form id="form">
    <input type="submit" value="Send"/>
    <input type="text" id="msg" size="64"/>
    <button id="createProfile">Create profile</button>
    <button id="getProfile">Get profile</button>
    <button id="updateProfile">Update profile</button>
    <button id="getProfiles">Get profiles</button>
    <button id="addAddress">Add address</button>
    <button id="getAddresses">Get addresses</button>
</form>
</body>
</html>
